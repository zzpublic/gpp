
<html lang="en">
    <head>
     <meta charset="UTF-8">
     <meta name="Generator" content="EditPlus®">
     <meta name="Author" content="">
     <meta name="Keywords" content="">
     <meta name="Description" content="">
     <title>Reward</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
   #xm .btn
   {
       min-width:150px;
       margin: 5px;
   }
   .addr
   {
        max-width:150px;overflow:hidden; text-overflow:ellipsis;
   }
    </style>
    </head>
    <body style="background: #333333;;color:rgb(248, 213, 148)">
        <div style="margin:0px auto;padding:10px 30px; background:#333">
                   <div class="col-md-6">
                        <div>
                                <h2 align="center">投资列表</h2>
                            <table class="table table-border table-condensed">
                                <tr>
                                    <th>序号</th>
                                    <th>用户</th>
                                    <th>数量</th>
                                    <th>时间</th>
                                    
                                </tr>
                                <tbody id="vls"></tbody>
                            </table>
                        </div>

                        <hr>
                        <div>
                                <h2 align="center">用户列表</h2>
                                <table class="table table-border ">
                                <tr>
                                    <th>序号</th>
                                    <th>用户</th>
                                    <th>推荐人</th>
                                    <th>投资总额</th>
                                </tr>
                                <tbody id="uls"></tbody>
                            </table>

                        </div>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-warning" onclick="compute(this)">计算</button>
                        <div></div>
                        <div></div>
                        <table class="table table-border">
                                <tr>
                                    <th>用户</th>
                                    <th>静态奖</th>
                                    <th>团队奖</th>
                                    <th>布道者</th>
                                    <th>幸运奖</th>
                                    <th>合计</th>
                                </tr>
                                <tbody id="rrls"></tbody>
                        </table>

                    </div>
           </div>
   
   
    </body>
   </html>
   <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
   <script src="web3.min.js"></script>
   
   <script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"></script>
   <script src="https://cdn.bootcss.com/crypto-js/3.1.9-1/crypto-js.min.js"></script>
   <script>
   
   var cc;
   var ok=false;
   var wallet;
   var isMetaMask=false;
   var uarr=[];
   var iarr=[];
   var mpsr=0;
   $(function(){
   
           web3 = new Web3(new Web3.providers.HttpProvider(nodeurl)); 
           if(localStorage["account_info"]!=null)
           {
               var m = JSON.parse(localStorage["account_info"]);
               web3.eth.defaultAccount = m.address;
           }
       var infoContract = web3.eth.contract(abi);
       cc= infoContract.at(contractAddr);
       getv(); 
       getu(); 
       getmp();
   });

   function compute(b)
   {
       var sum=0;
       var today=0;
       var rate = 0.022;
       var jt = new Date().toLocaleDateString();
        for(var i=0;i<iarr.length;i++)
        {
            sum+=iarr[i]["amount"];
            if(jt==iarr[i]["tm"])
            {
                today+=iarr[i]["amount"];
            }
        }
        $(b).next().html("理财总额:"+sum);
        $(b).next().next().html("今日入金:"+today+"<br>小奖池:"+(mpsr*0.3).toFixed(2));

        for(var i=0;i<uarr.length;i++)
        {
            $("#rrls").append("<tr><td class='addr'>"+uarr[i]["addr"]+"</td><td></td><td></td><td></td><td></td><td></td></tr>");
        }
        $("#rrls tr").find("td").each(function(i,v){
            if(i>0)
            {
                $(v).html("<input type='number' step='0.01'>");
            }
        });

   }
   function getmp()
   {
        
        cc.sellTicketIncome(function(error, result){
            mpsr = result/1e18;
        });
    }

   function getv()
   {
        
        cc.investsLength(function(error, result){
           if(!error)
           {
               console.log(JSON.parse(result));
               $("#vls").html("");
               for(let i=0;i<result;i++)
               {
                    cc.invests(i,function(error2, result2){
                        if(!error2)
                        {
                            $("#vls").append("<tr><td>"+i+"</td><td class='addr'>"+result2[0]+"</td><td>"+(result2[1]/1000000000000000000).toFixed(2)+"</td><td>"+(new Date(result2[2]*1000).toLocaleString())+"</td></tr>");
                            var m = {"addr":result2[0],"amount":result2[1]/1000000000000000000,"tm":new Date(result2[2]*1000).toLocaleDateString()};
                            iarr.push(m);
                        }
                    });
               }
           }  
           else
           {   console.error(error);}    
       })
   }

   function getu()
   {
        
        cc.usersLength(function(error, result){
           if(!error)
           {
               console.log(JSON.parse(result));
               $("#uls").html("");
               for(let i=0;i<result;i++)
               {
                    cc.users(i,function(error2, result2){
                        if(!error2)
                        {
                            $("#uls").append("<tr><td>"+i+"</td><td class='addr'>"+result2[0]+"</td><td>"+(result2[1]=="0x0000000000000000000000000000000000000000"?"":result2[1])+"</td><td>"+(result2[2]/1000000000000000000).toFixed(2)+"</td></tr>")
                            var m = {"addr":result2[0],"parent":result2[1],"amount":result2[2]/1000000000000000000,"reward":result2[3]/1000000000000000000,"rewardall":result2[4]/1000000000000000000};
                            uarr.push(m);
                        }
                    });
               }
           }  
           else
           {   console.error(error);}    
       })
   }
   </script>