<html lang="en">
    <head>
     <meta charset="UTF-8">
     <meta name="Generator" content="EditPlus®">
     <meta name="Author" content="">
     <meta name="Keywords" content="">
     <meta name="Description" content="">
     <title>TX</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
   #xm .btn
   {
       min-width:150px;
       margin: 5px;
   }
    </style>
    </head>
    <body style="background:#999;color:orange">
        <div style="max-width:1000px;margin:0px auto;padding:10px 30px; background:#333">
                   <!-- <a href="index.html">返回首页</a> -->

                   <div class="table" style="margin-top: 50px">
                       <span>当前账户</span> <span id="zh"></span><span>&nbsp;&nbsp;&nbsp;&nbsp;余额</span> <span id="ye"></span> ETH &nbsp;&nbsp;&nbsp;&nbsp;<p> 
                       <div id="ts1" style="margin:10px;padding:5px;border:1px solid #c00;display:none"></div>
                           
                   </div>
               
                  <div class="table"   style="margin-bottom: 50px">
                       <input type="text" id="mb" class="form-control" style="max-width: 400px" placeholder="目标账户"><p></p>
                       <input type="number" id="je" class="form-control" style="max-width: 400px" placeholder="转账金额"><p></p>
                       <input type="button" class="btn btn-info" onclick="dotx()" value="提交交易"><br>
                  </div>
                  <span id="ts"></span>
           </div>
   
   
    </body>
   </html>
   <script src="http://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
   <script src="web3.min.js"></script>
   
   <script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"></script>
   <script src="https://cdn.bootcss.com/crypto-js/3.1.9-1/crypto-js.min.js"></script>
   <script>
   var wallet;
   var isMetaMask=false;
   $(function(){
   
       //if (typeof web3 !== 'undefined') {
        //   isMetaMask=true;
        //    web3.version.getNetwork((err, netId) => {
        //    });
        //    getBalance();setInterval(getBalance,10000);
       //} 
       //else {
           web3 = new Web3(new Web3.providers.HttpProvider(nodeurl)); 
           if(localStorage["account_info"]!=null)
           {
               var m = JSON.parse(localStorage["account_info"]);
               $("#zh").html(m.address);
               web3.eth.defaultAccount = m.address;
               getBalance();setInterval(getBalance,10000);
               $("#logoutBtn").show();
           }
           else
           {
               $("#logoutBtn").hide();
               $("#importAccountPanel").show();
           }
       //}

       
   
   });

   function getBalance()
   {
       if(isMetaMask)
       {
           web3.eth.getAccounts((err, re) => {
               web3.eth.defaultAccount=re[0];
               document.querySelector('#zh').innerHTML= web3.eth.defaultAccount;
               web3.eth.getBalance(web3.eth.defaultAccount, function (error, balance) {
                       document.querySelector('#ye').innerHTML= (JSON.parse(balance)/1000000000000000000).toFixed(4);
               })
           });
       }
       else
       {
           web3.eth.getBalance(web3.eth.defaultAccount, function (error, balance) {
                       document.querySelector('#ye').innerHTML= (JSON.parse(balance)/1000000000000000000).toFixed(4);
           })
       }
      
       
   }
   
   function dotx()
   {
       var amount = $("#je").val();
       var toaddr = $("#mb").val();
       if(isMetaMask)
       {
           web3.eth.sendTransaction({
               from: document.querySelector('#zh').innerHTML,
               to: toaddr,
               value: (amount-0)*1000000000000000000,
               data: ''
           },function(receipt){
               console.log(receipt);
               alert("提交成功，请耐心等候");
           });
       }
       else
       {
           var x = prompt("请输入密码");
           var m =   JSON.parse(localStorage["account_info"]);
           let privateKey = AESDecrypt(m.pkey,x);
           if(privateKey.length!=66)
           {
               alert("密码错误");
               return;
           }
           let wallet = new ethers.Wallet(privateKey);
   
           web3.eth.getTransactionCount(web3.eth.defaultAccount,function(err,re){
               let transaction = {
                   to: toaddr,
                   nonce: re,
                   gasLimit: 21000,
                   gasPrice: 1000000000,
                   value: (amount-0)*1000000000000000000,
                   data:''
               };
               let signPromise = wallet.sign(transaction);
   
               signPromise.then((signedTransaction) => {
                   web3.eth.sendRawTransaction(signedTransaction, function(err, hash) {
                       if (!err)
                       {
                           console.log(hash); 
                           $("#ts").html(hash);
                       }
                       else
                       {
                           $("#ts").html(err);
                       }
                   });
               });
           });
           
       }
   
   
   }
   

 
   function AESDecrypt(word,password) {
       var key = CryptoJS.enc.Utf8.parse(CryptoJS.MD5(password).toString());
       var encryptedHexStr = CryptoJS.enc.Hex.parse(word);
       var encryptedBase64Str = CryptoJS.enc.Base64.stringify(encryptedHexStr);
       var decryptedData = CryptoJS.AES.decrypt(encryptedBase64Str, key, {
       mode: CryptoJS.mode.ECB,
       padding: CryptoJS.pad.Pkcs7
       });
       return  decryptedData.toString(CryptoJS.enc.Utf8);
   }
   
   function AESEncrypt(word,password) {
       var key = CryptoJS.enc.Utf8.parse(CryptoJS.MD5(password).toString());
       var encryptedData = CryptoJS.AES.encrypt(word, key, {
       mode: CryptoJS.mode.ECB,
       padding: CryptoJS.pad.Pkcs7
       });
       return encryptedData.ciphertext.toString();
   }


   </script>