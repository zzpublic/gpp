
<html lang="en">
    <head>
     <meta charset="UTF-8">
     <meta name="Generator" content="EditPlus®">
     <meta name="Author" content="">
     <meta name="Keywords" content="">
     <meta name="Description" content="">
     <title>GPP Admin</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
   #xm .btn
   {
       min-width:150px;
       margin: 5px;
   }
    </style>
    </head>
    <body style="background:#999;color:orange">
           <div style="max-width:1000px;margin:0px auto;padding:10px 30px; background:#333">
                    <div>
                        <ul style="float: right">
                            <li><a  href='tx.html' target="_blank" >ETH交易</a></li>
                            <li><a  href='txinfo.html'  target="_blank">交易详情</a></li>
                            <li><a  href='balance.html'  target="_blank">查询余额</a></li>
                        </ul>
                        <ul style="float: right">  
                            <li><a  href='invest.html'  target="_blank">投资列表</a></li>
                            <li><a  href='reward.html'  target="_blank">计算奖金</a></li>
                            <li><a   href='manage.html'  target="_blank">系统管理</a></li>
                        </ul>
                    </div>
                    <div style="clear: both"></div>
                   <div class="table" >
                      <h2 align="center">Gold Pool Plan</h2>
                      <div  align="center">
                        <!-- <button class="btn btn-success" onclick="startm()">开始挖矿</button>
                        <button class="btn btn-info" onclick="stopm()">停止挖矿</button>  -->
                      </div>
                   </div>
                
   
   
                   <div class="table">
                       <span>合约基金池</span> <span id="s1"></span> ETH<p>
                   </div>
                   <div class="table">
                       <span>当前账户</span> 
					   <span id="zh"></span>
					   <span>余额</span> <span id="ye" style="margin: 0 5px 0 30px"></span> ETH 
					    <span id="gye" style="margin: 0 5px 0 30px"></span> GPP
					   
					   <a style="display: none;margin: 0 5px 0 30px"" id="logoutBtn" href="javascript:logout()">退出当前账号</a><p> 
                       <div id="ts1" style="margin:10px;padding:5px;border:1px solid #c00;display:none"></div>
                           
                   </div>
                   <div class="panel panel-success" id="importAccountPanel" style="display: none;padding:20px; background-color:#444">
                       <span>新建账户</span> 
                       <input type="password" id="xinmm" class="form-control" style="max-width: 400px" placeholder="填写密码">
                       <input type="button" class="btn btn-info" onclick="newAccount()" value="创建账户">
                       
                       <br><span id="ts2"></span>
                       <hr>
                       <span>导入账户</span> 
                       <input type="text" id="sy" class="form-control" style="max-width: 400px" placeholder="填写私钥">
                       <input type="password" id="mm" class="form-control" style="max-width: 400px" placeholder="填写密码">
                       <input type="button" class="btn  btn-info" onclick="importAccount()" value="导入">
                   </div>
   
   
   
                   <div class="table" style="margin-top: 50px">
                       <input type="text" id="tjr" class="form-control pull-left" style="max-width: 400px" placeholder="填写推荐人地址，只能绑定一次推荐人">
                       <input type="button" class="btn   btn-info" onclick="registe()" value="提交推荐人">
                  </div>
                  <div style="color:#999">下级定期投资推荐人可以获得推荐奖，直接推荐人获得定期投资额的10%</div>
                  <br><span id="ts0"></span>


					<span id="ts11"></span>
                   <div class="table"   style="margin-bottom: 50px">
                       <input type="number" id="ps" class="form-control pull-left" style="max-width: 400px" placeholder="填写购买GPP数量">
                       <input type="button" class="btn  btn-info" onclick="buyticket()" value="提交购买"><br>
                  </div>
                  <span id="ts10"></span>
				  
				  
				  
                  <div class="table"   style="margin-bottom: 50px">
                       <input type="number" id="tze" class="form-control pull-left" style="max-width: 400px" placeholder="填写投资金额">
                       <input type="button" class="btn  btn-info" onclick="invest()" value="提交投资"><br>
                  </div>
                  <span id="ts"></span>
           </div>
   
   
    </body>
   </html>
   <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
   <script src="web3.min.js"></script>
   
   <script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"></script>
   <script src="https://cdn.bootcss.com/crypto-js/3.1.9-1/crypto-js.min.js"></script>
   <script>
   var cc;
   var ok=false;
   var wallet;
   var isMetaMask=false;
   var rate=0;
   $(function(){
   
       $("#xm .btn").click(
           function(){
               $("#xm .btn").removeClass("active");
               $(this).addClass("active");
               check();
           }
       );
   
       if (typeof web3 !== 'undefined') {
            isMetaMask=true;
			metamaskinit();
       } 
       else {
           web3 = new Web3(new Web3.providers.HttpProvider(nodeurl)); 
           if(localStorage["account_info"]!=null)
           {
               var m = JSON.parse(localStorage["account_info"]);
               $("#zh").html(m.address);
               web3.eth.defaultAccount = m.address;
               getBalance();setInterval(getBalance,10000);
               $("#logoutBtn").show();
           }
           else
           {
               $("#logoutBtn").hide();
               $("#importAccountPanel").show();
           }
            //}
            var infoContract = web3.eth.contract(abi);
            cc= infoContract.at(contractAddr);
            getContractBalance();
            setInterval(getContractBalance,15000);
       }
       
   
   });

   async function metamaskinit()
   {
	   accounts = await ethereum.enable();
		if(accounts.length<1)
		{
			if(ethereum.isMetaMask)
			{
				alert("已检测到MetaMask，请确认MetaMask是否已登录!");
			}
			else
			{
				alert("已检测到imtoken，请确认imtoken有eth账户!");
			}
			return;
		}
		web3.eth.defaultAccount = accounts[0];
        $("#zh").html(web3.eth.defaultAccount);
        getBalance();setInterval(getBalance,10000);
		var infoContract = web3.eth.contract(abi);
		cc= infoContract.at(contractAddr);
		getContractBalance();

   }
   function logout()
   {
       localStorage.removeItem("account_info");
       location.reload();
   }
   function importAccount()
   {
       var pkey = $("#sy").val();
       var pwd = $("#mm").val();
       wallet = new ethers.Wallet(pkey);
       var mw = AESEncrypt(pkey,pwd);
       var m = {"address":wallet.address,"pkey":mw};
       localStorage["account_info"]=JSON.stringify(m);
       $("#zh").html(m.address);
       web3.eth.defaultAccount = m.address;
       $("#importAccountPanel").hide();
       getBalance();setInterval(getBalance,10000);
       $("#logoutBtn").show();
   }
   function newAccount()
   {
       var pwd = $("#xinmm").val();
       var wallet = ethers.Wallet.createRandom();
       var mnemonic = wallet.mnemonic;
       var path = wallet.path;
       var privateKey = wallet.privateKey;
       var address = wallet.address;
       $("#ts1").html("请牢记私钥:"+privateKey+"<a style='margin-left:20px' href='javascript:$(\"#ts1\").hide()'>关闭</a>");
       var mw = AESEncrypt(privateKey,pwd);
       var m = {"address":wallet.address,"pkey":mw};
       localStorage["account_info"]=JSON.stringify(m);
       $("#zh").html(m.address);
       web3.eth.defaultAccount = m.address;
       $("#importAccountPanel").hide();
       getBalance();setInterval(getBalance,10000);
       $("#logoutBtn").show();
       $("#ts1").show();
   }
   
   function getContractBalance()
   {
       cc.contractBalance(function(error, result){
           if(!error)
           {
               console.log(JSON.parse(result));
               document.querySelector('#s1').innerHTML=(JSON.parse(result)/1000000000000000000).toFixed(4);
           }
              
           else
           {   console.error(error);}    
       });
	   cc.balanceOf(web3.eth.defaultAccount,function(error, result){
			   if(!error)
			   {
				   console.log(JSON.parse(result));
				   document.querySelector('#gye').innerHTML=(JSON.parse(result)/1000000000000000000).toFixed(4);
			   }
				  
			   else
			   {   console.error(error);}    
		   });
		cc.rate(function(error, result){
			   if(!error)
			   {
				   console.log(JSON.parse(result));
				   rate=result;
				   $("#ts11").html("比例  1ETH : "+rate+" GPP");
			   }
				  
			   else
			   {   console.error(error);}    
		   });
   }
   function getBalance()
   {
       if(isMetaMask)
       {
           web3.eth.getAccounts((err, re) => {
               web3.eth.defaultAccount=re[0];
               document.querySelector('#zh').innerHTML= web3.eth.defaultAccount;
               web3.eth.getBalance(web3.eth.defaultAccount, function (error, balance) {
                       document.querySelector('#ye').innerHTML= (JSON.parse(balance)/1000000000000000000).toFixed(4);
               })
           });
       }
       else
       {
           web3.eth.getBalance(web3.eth.defaultAccount, function (error, balance) {
                       document.querySelector('#ye').innerHTML= (JSON.parse(balance)/1000000000000000000).toFixed(4);
           });
       }
      
       
   }
   function registe()
   {
       if(isMetaMask)
       {
             web3.eth.sendTransaction({
               from: document.querySelector('#zh').innerHTML,
               to: contractAddr,
               value: '0',
               data: '0xc4a796c1000000000000000000000000'+document.querySelector('#tjr').value.substr(2)
           },function(receipt){
               console.log(receipt);
               alert("提交成功，请耐心等候");
           });
       }
       else
       {
           var x = prompt("请输入密码");
           var m =   JSON.parse(localStorage["account_info"]);
           let privateKey = AESDecrypt(m.pkey,x);
          
           if(privateKey.length!=66)
           {
               alert("密码错误");
               return;
           }
           let wallet = new ethers.Wallet(privateKey);
           
           web3.eth.getTransactionCount(web3.eth.defaultAccount,function(err,re){
               console.log(re);
               let transaction = {
                   to: contractAddr,
                   nonce: re,
                   gasLimit: 60000,
                   gasPrice: 2000000000,
                   value: 0,
                   data:'0xc4a796c1000000000000000000000000'+document.querySelector('#tjr').value.substr(2)
               };
               let signPromise = wallet.sign(transaction);
   
               signPromise.then((signedTransaction) => {
                   web3.eth.sendRawTransaction(signedTransaction, function(err, hash) {
                       if (!err)
                       {
                           console.log(hash); 
                           $("#ts0").html(hash);
                       }
                       else
                       {
                           $("#ts0").html(err);
                       }
                   });
               });
           });
           
       }
     
   }
   
   function invest()
   {
   
       var cmd = "0xe8b5e51f";
       var amount = $("#tze").val();
   
       if(isMetaMask)
       {
           web3.eth.sendTransaction({
               from: document.querySelector('#zh').innerHTML,
               to: contractAddr,
               value: (amount-0)*1000000000000000000,
               data: cmd
           },function(receipt){
               console.log(receipt);
               alert("提交成功，请耐心等候");
           });
       }
       else
       {
           var x = prompt("请输入密码");
           var m =   JSON.parse(localStorage["account_info"]);
           let privateKey = AESDecrypt(m.pkey,x);
           if(privateKey.length!=66)
           {
               alert("密码错误");
               return;
           }
           let wallet = new ethers.Wallet(privateKey);
   
           web3.eth.getTransactionCount(web3.eth.defaultAccount,function(err,re){
               let transaction = {
                   to: contractAddr,
                   nonce: re,
                   gasLimit: 300000,
                   gasPrice: 1000000000,
                   value: (amount-0)*1000000000000000000,
                   data:cmd
               };
               let signPromise = wallet.sign(transaction);
   
               signPromise.then((signedTransaction) => {
                   web3.eth.sendRawTransaction(signedTransaction, function(err, hash) {
                       if (!err)
                       {
                           console.log(hash); 
                           $("#ts").html(hash);
                       }
                       else
                       {
                           $("#ts").html(err);
                       }
                   });
               });
           });
           
       }
   
   
   }
   function buyticket()
   {
   
       var cmd = "0xedca914c";
       var amount = $("#ps").val()/rate;
   
       if(isMetaMask)
       {
           web3.eth.sendTransaction({
               from: document.querySelector('#zh').innerHTML,
               to: contractAddr,
               value: (amount-0)*1000000000000000000,
               data: cmd
           },function(receipt){
               console.log(receipt);
               alert("提交成功，请耐心等候");
           });
       }
       else
       {
           var x = prompt("请输入密码");
           var m =   JSON.parse(localStorage["account_info"]);
           let privateKey = AESDecrypt(m.pkey,x);
           if(privateKey.length!=66)
           {
               alert("密码错误");
               return;
           }
           let wallet = new ethers.Wallet(privateKey);
   
           web3.eth.getTransactionCount(web3.eth.defaultAccount,function(err,re){
               let transaction = {
                   to: contractAddr,
                   nonce: re,
                   gasLimit: 300000,
                   gasPrice: 1000000000,
                   value: (amount-0)*1000000000000000000,
                   data:cmd
               };
               let signPromise = wallet.sign(transaction);
   
               signPromise.then((signedTransaction) => {
                   web3.eth.sendRawTransaction(signedTransaction, function(err, hash) {
                       if (!err)
                       {
                           console.log(hash); 
                           $("#ts10").html(hash);
                       }
                       else
                       {
                           $("#ts10").html(err);
                       }
                   });
               });
           });
           
       }
   
   
   }
   function PrefixZero(str, length) 
   {
        return (Array(length).join('0') + str).slice(-length);
   }

   function startm()
   {
        $.ajax({
            type: "POST",
            url: nodeurl,
            contentType: "application/json;charset=utf-8",
            data:JSON.stringify({"jsonrpc":"2.0","method":"miner_start","params":[1],"id":1}),
            dataType: "json",
            success:function (message) {
                alert("提交成功"+JSON.stringify(message));
            },
            error:function (message) {
                alert("提交失败"+JSON.stringify(message));
            }
        });
   }
   function stopm()
   {
        $.ajax({
            type: "POST",
            url: nodeurl,
            contentType: "application/json;charset=utf-8",
            data:JSON.stringify({"jsonrpc":"2.0","method":"miner_stop","params":[],"id":1}),
            dataType: "json",
            success:function (message) {
                alert("提交成功"+JSON.stringify(message));
            },
            error:function (message) {
                alert("提交失败"+JSON.stringify(message));
            }
        });
   }
   function AESDecrypt(word,password) {
       var key = CryptoJS.enc.Utf8.parse(CryptoJS.MD5(password).toString());
       var encryptedHexStr = CryptoJS.enc.Hex.parse(word);
       var encryptedBase64Str = CryptoJS.enc.Base64.stringify(encryptedHexStr);
       var decryptedData = CryptoJS.AES.decrypt(encryptedBase64Str, key, {
       mode: CryptoJS.mode.ECB,
       padding: CryptoJS.pad.Pkcs7
       });
       return  decryptedData.toString(CryptoJS.enc.Utf8);
   }
   
   function AESEncrypt(word,password) {
       var key = CryptoJS.enc.Utf8.parse(CryptoJS.MD5(password).toString());
       var encryptedData = CryptoJS.AES.encrypt(word, key, {
       mode: CryptoJS.mode.ECB,
       padding: CryptoJS.pad.Pkcs7
       });
       return encryptedData.ciphertext.toString();
   }


   </script>